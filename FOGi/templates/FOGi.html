<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FOGi</title>
<style>
  :root{
    --azul:#38a5ff;
    --user:#e7f3ff;
    --bot:#ffffff;
    --gray:#d8dee9;
  }
  *{margin:0;padding:0;box-sizing:border-box;font-family:Poppins,system-ui,Arial,sans-serif}
  html,body{height:100%}
  body{
    height:100vh;
    display:flex;
    flex-direction:column;
    background:#f5faff;
    color:#0b1220;
  }

  /* header */
  .top{
    background:#fff;
    border-bottom:1px solid var(--gray);
    padding:8px 12px;
    display:flex;
    align-items:center;
    justify-content:space-between;
  }
  .brand{display:flex;align-items:center;gap:8px}
  .logo{width:32px;height:32px;background:var(--azul);color:#fff;display:flex;align-items:center;justify-content:center;font-weight:600}
  .title{font-size:0.95rem;font-weight:600}
  .close{
    background:none;
    border:none;
    color:#555;
    font-size:1.3rem;
    cursor:pointer;
    padding:4px 8px;
    transition:0.2s;
  }
  .close:hover{color:#000;transform:scale(1.1)}

  /* chat */
  .chat-wrap{
    flex:1;
    display:flex;
    flex-direction:column;
    min-height:0;
  }

  .msgs{
    flex:1;
    overflow:auto;
    padding:12px 10px 86px;
    display:flex;
    flex-direction:column;
    gap:8px;
    min-height:0;
  }

  .bubble{
    max-width:85%;
    padding:10px 12px;
    border-radius:6px;
    font-size:0.95rem;
    line-height:1.4;
    word-break:break-word;
    border:1px solid #e9eef6;
  }
  .bot{align-self:flex-start;background:var(--bot)}
  .user{align-self:flex-end;background:var(--user)}

  .composer{
    position:sticky;
    bottom:0;
    background:#fff;
    border-top:1px solid var(--gray);
    display:flex;
    gap:8px;
    padding:10px;
    align-items:center;
    z-index:5;
  }

  .composer input{
    flex:1;
    border:1px solid var(--gray);
    padding:12px;
    border-radius:6px;
    font-size:0.95rem;
    outline:none;
    background:#fff;
  }
  .composer input:focus{box-shadow:0 0 0 4px rgba(56,165,255,.06);border-color:var(--azul)}

  .composer button{
    padding:0 16px;
    height:40px;
    border:0;
    background:var(--azul);
    color:#fff;
    border-radius:6px;
    font-weight:600;
    cursor:pointer;
  }

  .msgs::-webkit-scrollbar{width:8px}
  .msgs::-webkit-scrollbar-thumb{background:#c5dbff;border-radius:99px}
</style>
</head>
<body>
  <header class="top">
    <div class="brand">
      <div class="logo">FOG</div>
      <div class="title">FOGi — Chat</div>
    </div>
    <button id="exit" class="close" title="Fechar">✕</button>
  </header>

  <div class="chat-wrap">
    <div id="msgs" class="msgs" aria-live="polite" tabindex="0">
      <div class="bubble bot">Oi, sou a FOGi. Manda sua dúvida direto.</div>
    </div>

    <div class="composer" role="region" aria-label="Enviar mensagem">
      <input id="msg" type="text" placeholder="Pergunte algo..." autocomplete="off" />
      <button id="send" aria-label="Enviar">Enviar</button>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.7.5/dist/socket.io.min.js"></script>
<script>
  // Se o socket não conectar, troque por io("http://127.0.0.1:5000")
  const socket = io();
  const msgs = document.getElementById('msgs');
  const input = document.getElementById('msg');
  const sendBtn = document.getElementById('send');
  const exitBtn = document.getElementById('exit');
  let assemblingEl = null;

  function addBubble(text, who='bot'){
    const el = document.createElement('div');
    el.className = 'bubble ' + (who === 'user' ? 'user' : 'bot');
    el.textContent = text;
    msgs.appendChild(el);
    setTimeout(()=> msgs.scrollTop = msgs.scrollHeight, 10);
    return el;
  }

  sendBtn.addEventListener('click', () => {
    const text = input.value.trim();
    if(!text) return;
    addBubble(text, 'user');
    input.value = '';
    assemblingEl = addBubble('...', 'bot');
    sendBtn.disabled = true;
    socket.emit('user_message', { text });
  });

  input.addEventListener('keydown', (e) => {
    if(e.key === 'Enter') sendBtn.click();
  });

  socket.on('assistant_chunk', ({text}) => {
    if(assemblingEl){
      assemblingEl.textContent = (assemblingEl.textContent === '...') ? text : assemblingEl.textContent + text;
      msgs.scrollTop = msgs.scrollHeight;
    }
  });

  socket.on('assistant_done', ({full}) => {
    if(assemblingEl) assemblingEl.textContent = full;
    assemblingEl = null;
    sendBtn.disabled = false;
  });

  socket.on('assistant_error', ({message}) => {
    addBubble('Erro: ' + message, 'bot');
    assemblingEl = null;
    sendBtn.disabled = false;
  });

  // Botão X envia postMessage pro site fechar o modal
  exitBtn.addEventListener('click', () => {
    if(window.parent && window.parent !== window){
      window.parent.postMessage({ type: 'FOGI_CLOSE' }, '*');
    } else {
      window.close();
    }
  });

  input.focus();
</script>
</body>
</html>
